# Databricks App Deployment Guide - OBO Configuration

## üéØ Overview

This Databricks App is configured to use **On-Behalf-Of (OBO) authentication**, ensuring that each user's queries are executed with their own permissions, enabling Row-Level Security (RLS).

---

## üìã OBO Configuration Checklist

### ‚úÖ 1. App Code Configuration (Already Done!)

**File: `app.py`**

The app is already configured to extract and use user credentials:

```python
# Line 681-686 in app.py
user_token = request.headers.get('X-Forwarded-Access-Token')
user_email = request.headers.get('X-Forwarded-Email', 'unknown')
print(f"Processing request for user: {user_email}")
print(f"Using OBO token: {'Yes' if user_token else 'No (fallback to app token)'}")

# Pass user token to agent
agent_response = get_agent_response(conversation_history, user_token=user_token)
```

‚úÖ **Status: Implemented**

---

### ‚úÖ 2. App Startup Configuration

**File: `app.yaml`**

```yaml
command:
  - python
  - app.py
```

This ensures the app runs the web UI (`app.py`), not the agent code (`agent.py`).

‚úÖ **Status: Updated**

---

### ‚ö†Ô∏è 3. Databricks Apps UI Settings

**You MUST enable OBO in the Databricks Apps UI:**

1. **Go to:** Databricks workspace ‚Üí Apps ‚Üí Your app ‚Üí Settings

2. **Find:** "User authorization" or "OAuth" section

3. **Verify these settings:**
   ```
   ‚úÖ User authorization: Enabled (Preview)
   ‚úÖ OAuth2 App Client ID: <auto-generated>
   ‚úÖ API Scopes: At minimum, default scopes
   ```

4. **Required API Scopes for this app:**
   - `iam.current-user:read` (default)
   - `iam.access-control:read` (default)
   - **`serving.serving-endpoints`** ‚Üê **CRITICAL! Required to call agent endpoint**
   
   **Without this scope, you'll get: "Invalid scope" error!**

---

### ‚ö†Ô∏è 4. Service Principal Configuration

**The app needs BOTH:**

1. **Service Principal** (for app infrastructure)
   - Environment vars: `DATABRICKS_CLIENT_ID`, `DATABRICKS_CLIENT_SECRET`
   - Used for: App initialization, non-user-specific operations
   
2. **User Authorization** (for OBO)
   - Header: `X-Forwarded-Access-Token`
   - Used for: Agent calls, user-specific queries

**Both are automatically provided by Databricks Apps when configured correctly.**

---

## üîç How OBO Works in Your App

### Architecture Flow:

```
1. User (alice@company.com) opens the app in browser
   ‚Üì
2. Databricks Apps injects headers:
   - X-Forwarded-Email: alice@company.com
   - X-Forwarded-Access-Token: <Alice's OAuth token>
   ‚Üì
3. app.py extracts user token from headers
   ‚Üì
4. app.py calls Model Serving Endpoint with Alice's token
   ‚Üì
5. Agent uses Alice's credentials (OBO)
   ‚Üì
6. Genie queries tables as Alice
   ‚Üì
7. Unity Catalog applies RLS based on Alice's permissions
   ‚Üì
8. Returns ONLY data Alice can see (e.g., HR only)
```

---

## üöÄ Deployment Steps

### Step 1: Update App Code
```bash
# Already done - code is in Git
git pull origin main
```

### Step 2: Configure Databricks App

**In Databricks Apps UI:**

1. **App source:**
   - Source: Git repository
   - Path: Point to your repo
   - Branch: `main`

2. **App authorization:**
   - ‚úÖ Service principal: Created automatically
   - ‚úÖ User authorization: **ENABLE THIS** (Preview feature)

3. **Save and Deploy**

### Step 3: Verify Configuration

**Check deployment logs for:**
```
‚úÖ Starting server on http://0.0.0.0:8080
‚úÖ Dash is running on http://0.0.0.0:8080/
‚úÖ Authentication mode: Databricks Apps (using on-behalf-of authentication)
```

**NOT:**
```
‚ùå Agent configuration loaded
‚ùå LangGraphResponsesAgent initialized
```

---

## üß™ Testing OBO

### Test 1: Check Headers

**In app logs, you should see:**
```
Processing request for user: your.email@company.com
Using OBO token: Yes
```

**If you see:**
```
Using OBO token: No (fallback to app token)
```
‚Üí ‚ùå **User authorization not enabled in app settings!**

---

### Test 2: Verify RLS Enforcement

**User A (HR access):**
```
Query: "Show me attrition by department"
Expected: Only HR department
```

**User B (Sales access):**
```
Query: "Show me attrition by department"
Expected: Only Sales department
```

**If all users see ALL departments:**
‚Üí ‚ùå **OBO not working - check app authorization settings!**

---

## üêõ Troubleshooting

### Issue 1: "Invalid scope" Error When Calling Agent

**Error message:**
```
‚ö†Ô∏è Permission Error: Your account doesn't have access to the agent endpoint.
Technical details: Invalid scope
```

**Cause:** App doesn't have `serving.serving-endpoints` scope to call the agent on behalf of users.

**Fix:**
1. Go to Databricks Apps ‚Üí Your app ‚Üí Settings
2. Find "API Scopes" section
3. Add scope: `serving.serving-endpoints`
4. Redeploy/restart app
5. In app.py, change `use_obo = True`

**Temporary workaround:** 
- In app.py, set `use_obo = False` to use app token instead of user token
- This works but RLS won't be enforced (all users see all data)

---

### Issue 2: "Using OBO token: No"

**Cause:** User authorization not enabled in Databricks Apps

**Fix:**
1. Go to app settings
2. Find "User authorization" section
3. Enable it (may be marked as "Preview")
4. Redeploy app

---

### Issue 2: "Error reading app.yaml file"

**Cause:** Invalid app.yaml format

**Fix:** The current `app.yaml` uses minimal valid format:
```yaml
command:
  - python
  - app.py
```

If this still fails, remove `app.yaml` and configure startup command through UI.

---

### Issue 3: App runs agent.py instead of app.py

**Symptoms:**
```
Logs show: "Agent configuration loaded"
```

**Fix:**
1. Check `app.yaml` command is `python app.py`
2. Or set startup command in UI to `python app.py`
3. Restart app

---

### Issue 4: All users see all data (RLS not working)

**Causes:**
1. User authorization not enabled ‚Üí Enable in app settings
2. Agent not configured for OBO ‚Üí Already fixed in code
3. Genie Space credential mode set to "embedded" ‚Üí Check Genie Space settings

**Fix for #3:**
- Go to Genie Space settings
- Find "Credential mode"
- Should be: "Run as viewer" (not "Embedded credentials")

---

## üìä Verification Checklist

After deployment, verify:

- [ ] App loads in browser (no "Agent configuration loaded" errors)
- [ ] App logs show user email when you interact with it
- [ ] App logs show "Using OBO token: Yes"
- [ ] Different users see different data based on RLS
- [ ] No permission denied errors in app responses

---

## üîê Security Notes

**What's protected by OBO:**
- ‚úÖ Genie Space queries (user-specific)
- ‚úÖ Unity Catalog table access (RLS enforced)
- ‚úÖ Model serving endpoint calls (user context preserved)

**What uses Service Principal:**
- App initialization and startup
- Non-user-specific operations (if any)

**User privacy:**
- User tokens are NOT logged
- Only user emails are logged for debugging
- Tokens are passed through memory, not stored

---

## üìû Quick Reference

**App.yaml location:** Root of repo  
**Startup command:** `python app.py`  
**Main file:** `app.py` (web UI)  
**Agent file:** `agent.py` (generated, for model serving endpoint)  
**OBO configuration:** Lines 681-686 in app.py  

**Key setting in Databricks Apps UI:**  
‚Üí User authorization: **MUST BE ENABLED** ‚ö†Ô∏è

---

## üéâ Success Criteria

Your app is working correctly when:

1. ‚úÖ App loads and shows chat UI
2. ‚úÖ Logs show: "Using OBO token: Yes"
3. ‚úÖ User A sees only their permitted data
4. ‚úÖ User B sees only their permitted data (different from User A)
5. ‚úÖ No permission denied errors
6. ‚úÖ RLS is enforced based on user identity

---

**If you're still seeing issues, check that "User authorization" is enabled in the Databricks Apps UI settings. This is the most common missing configuration!** ‚ö†Ô∏è

